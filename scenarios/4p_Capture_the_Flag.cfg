#textdomain wesnoth-Survivals_WoL

#define SCORE_STR
_ "West    | Captures Needed |    East 
    <span fgcolor='green'>$team_west_score</span>       |              <span fgcolor='khaki'>$knyght_CTF_point_threshold</span>             |       <span fgcolor='gold'>$team_east_score</span>
Team West Flag   |   Team East Flag
    <span fgcolor='green'>$team_west_flag_base</span>                |             <span fgcolor='gold'>$team_east_flag_base</span>"
#enddef

#define SCORE_BOARD_HEADER
    [header_message]
        caption= _ "Capture the Flag"
        message={SCORE_STR}
    [/header_message]
#enddef

#define TEAM_WEST_AGGRESSION SIDE
    # having scored AI must return to what it was doing before
    {MODIFY_AI_ADD_GOAL {SIDE} (
        # set off for enemy flag post
        [goal]
            id=side_{SIDE}_enemy_base
            name=target_location
            [criteria]
                x,y=40,11
            [/criteria]
            value=800
        [/goal]
    )}
#enddef

#define TEAM_WEST_STEAL_FLAG SIDE
    # AI side unit has stolen the flag
    # so we withdraw most units to middle
    {MODIFY_AI_DELETE_GOAL {SIDE} side_{SIDE}_enemy_base}
#enddef

#define TEAM_EAST_AGGRESSION SIDE
    # having scored AI must return to what it was doing before
    {MODIFY_AI_ADD_GOAL {SIDE} (
        # set off for enemy flag post
        [goal]
            id=side_{SIDE}_enemy_base
            name=target_location
            [criteria]
                x,y=8,11
            [/criteria]
            value=800
        [/goal]
    )}
#enddef

#define TEAM_EAST_STEAL_FLAG SIDE
    # AI side unit has stolen the flag
    # so we withdraw most units to middle
    {MODIFY_AI_DELETE_GOAL {SIDE} side_{SIDE}_enemy_base}
#enddef

#define ADD_FLAG_OVERLAY
    [unit_overlay]
        id=$unit.id
        image=overlays/flag-carrier.png
    [/unit_overlay]
#enddef

#define REMOVE_FLAG_OVERLAY
    [remove_unit_overlay]
        id=$unit.id
        image=overlays/flag-carrier.png
    [/remove_unit_overlay]
#enddef

#define CHAT_MSG_UPDATE MSG_STR
[chat]
    speaker="Capture the Flag"
    message={MSG_STR}
[/chat]
#enddef

#define MP_CTF_SCENARIO_DESC
_ "This multiplayer scenario allows players to participate in the Battle for Wesnoth's iteration of the game mode <span fgcolor='turquoise'><b>Capture the Flag (CTF)</b></span>.

<span fgcolor='turquoise'><b>Capture the Flag has the following rules:</b></span>
1. Players play in two teams. <span fgcolor='turquoise'>East</span> (P1 &amp; P3) and <span fgcolor='turquoise'>West</span> (P2 &amp; P4).
2. The scenario has to be won by <span fgcolor='turquoise'>capturing the flag</span> a certain number of times. This number is customisable and defaulted to <span fgcolor='turquoise'>3</span>.
3. To <span fgcolor='turquoise'>capture the flag</span>, one of your team's unit has to move to the enemy base. They become the <span fgcolor='turquoise'><b>flag carrier</b></span>, receiving a <span fgcolor='turquoise'>custom status and overlay</span> to distinguish them from regular units.
4. To <span fgcolor='turquoise'>score</span>, the team <b>flag carrier</b> must be moved or escorted to the team's base. That is, <span fgcolor='turquoise'>taking the Western flag to the eastern base and vice versa</span>.
5. The stolen flag can be <span fgcolor='turquoise'>returned</span> to the team base by killing the enemy <b>flag carrier</b>.
6. The flag cannot be transferred between units.
7. Side <b>leaders</b> cannot be permanently killed in this scenario mode. Instead, they are teleported to their base's interior.
8. The objective of the game mode is capturing the flag so targetting side leaders is not recommended. 

<span fgcolor='turquoise'><b>Extra Information:</b></span>
1. If you get bored and/or frustrated at long waiting times for players to join, you may set <b>any side to AI controller</b>. <span fgcolor='turquoise'>The AI for this scenario has been tailored specifically to play this game mode to an optimal capacity</span>.
2. For <span fgcolor='turquoise'>further challenge</span>, the scenario also supports options for allowing AI-controlled monster spawns at specific intervals. The difficulty and quantity spawn can be modified by checkboxs under <b>Custom Options</b>.
3. There are also options to spawn <span fgcolor='turquoise'>Defenders</span> for each base."
#enddef

#ifdef RETIRED_PROJECT
[multiplayer]
    id=multiplayer_2v2_Capture_the_Flag_knyght
    name= _ "4p â€” Capture the Flag (2v2)"
    map_file=Capture_the_Flag.map
    turns=unlimited

    description={MP_CTF_SCENARIO_DESC}

    force_lock_settings=yes

    experience_modifier=100
    require_scenario=yes
    victory_when_enemies_defeated=no

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    # team west
    [side]
        side=1
        user_team_name=_ "West"
        team_name="west"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=2
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_1_enemy_base
                name=target_location
                [criteria]
                    x,y=40,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_1_home_base
                name=protect_location
                [criteria]
                    x,y=8,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_1_enemy_flag_carrier
                name=target
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_1_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # keep clear of enemy interior
            [avoid]
                x=42-47, 41, 40, 39,38,   39,   40,   41,38
                y= 1-21,4-8,4-8,6-7, 6,17-16,14-18,15-19,16
            [/avoid]
        [/ai]
    [/side]

    # team east
    [side]
        side=2
        user_team_name=_ "East"
        team_name="east"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=2
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_2_enemy_base
                name=target_location
                [criteria]
                    x,y=8,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_2_home_base
                name=protect_location
                [criteria]
                    x,y=40,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_2_enemy_flag_carrier
                name=target
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_2_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # keep clear of enemy interior
            [avoid]
                x= 1-6,  7,  8,  9,    9,    8,    7,10,10
                y=1-21,4-8,4-8,6-7,16-17,14-18,15-19, 6,16
            [/avoid]
        [/ai]
    [/side]

    # team west
    [side]
        side=3
        user_team_name=_ "West"
        team_name="west"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=2
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_3_enemy_base
                name=target_location
                [criteria]
                    x,y=40,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_3_home_base
                name=protect_location
                [criteria]
                    x,y=8,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_3_enemy_flag_carrier
                name=target
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_3_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # keep clear of enemy interior
            [avoid]
                x=42-47, 41, 40, 39,38,   39,   40,   41,38
                y= 1-21,4-8,4-8,6-7, 6,17-16,14-18,15-19,16
            [/avoid]
        [/ai]
    [/side]

    # team east
    [side]
        side=4
        user_team_name=_ "East"
        team_name="east"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=2
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_4_enemy_base
                name=target_location
                [criteria]
                    x,y=8,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_4_home_base
                name=protect_location
                [criteria]
                    x,y=40,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_4_enemy_flag_carrier
                name=target
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_4_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # keep clear of enemy interior
            [avoid]
                x= 1-6,  7,  8,  9,    9,    8,    7,10,10
                y=1-21,4-8,4-8,6-7,16-17,14-18,15-19, 6,16
            [/avoid]
        [/ai]
    [/side]

    # AI side
    [side]
        side=5
        user_team_name=_ "Monsters"
        team_name="monsters"
        controller=ai
        no_leader=yes
        gold=0
        income=-2
        defeat_condition=never
        hidden=yes
        fog=no
        shroud=no
        allow_player=no
        disallow_observers=yes
        controller_lock=yes
        team_lock=yes
        [ai]
            leader_value=7.0
            aggression=0.99
            caution=0.0
        [/ai]
    [/side]

    # AI side team west base guards
    [side]
        side=6
        no_leader=yes
        team_name="west,monsters"
        controller=ai
        allow_player=no
        hidden=yes
        fog=yes
        gold=0
        income=-2
        defeat_condition=never
        disallow_observers=yes
        controller_lock=yes
        team_lock=yes

        [ai]
            leader_value=7.0
            aggression=0.99
            caution=0.0
        [/ai]
    [/side]

    # AI side team east base guards
    [side]
        side=7
        no_leader=yes
        team_name="east,monsters"
        controller=ai
        allow_player=no
        hidden=yes
        fog=yes
        gold=0
        income=-2
        defeat_condition=never
        disallow_observers=yes
        controller_lock=yes
        team_lock=yes
        [ai]
            leader_value=7.0
            aggression=0.99
            caution=0.0
        [/ai]
    [/side]

    # load the lua
    [lua]
        code = <<
        wesnoth.dofile("~add-ons/Survivals_WoL/lua/header_message.lua")
    >>
    [/lua]
    [lua]
        code = <<
        wesnoth.dofile("~add-ons/Survivals_WoL/lua/capture_the_flag.lua")
    >>
    [/lua]

    # prestart event
    [event]
        name=prestart

        # adjust ambience
        {COLOR_ADJUST -15 -15 -15}

        # define team score vars 
        {VARIABLE team_west_score 0}
        {VARIABLE team_east_score 0}

        # more vars
        {VARIABLE team_west_flag_base "base"}
        {VARIABLE team_east_flag_base "base"}

        # objectives
        [objectives]
            [objective]
                description= _ "Capture the Opposing Team's Flag $knyght_CTF_point_threshold time(s)"
                condition="win"
            [/objective]
            [objective]
                description= _ "Your flag is capped $knyght_CTF_point_threshold time(s)"
                condition="lose"
            [/objective]

            [note]
                description= _ "Team Leaders cannot be killed permanently in this mode."
            [/note]
            [note]
                description= _ "If killed, leaders will spawn near their keeps."
            [/note]
            [note]
                description= _ "To capture the flag, move any unit onto the enemy base."
            [/note]
            [note]
                description= _ "To score, move the flag-carrier unit to your own base."
            [/note]
            [note]
                description= _ "Scoring is only possible if your base has its flag."
            [/note]
            [note]
                description= _ "Flag carrier units cannot transfer their flags to allied units."
            [/note]
            [note]
                description= _ "Flag is returned to base if enemy flag carrier is killed."
            [/note]
            [note]
                description= _ "Avoid Attacking the interior base of the enemy team."
            [/note]
        [/objectives]

        # give +1 starting village for sides 2,3,4
        [capture_village]
            side=2
            x,y=40,18
        [/capture_village]
        [capture_village]
            side=3
            x,y=8,18
        [/capture_village]
        [capture_village]
            side=4
            x,y=40,4
        [/capture_village]

        # add labels
        [label]
            x,y=8,11
            text= _ "Western Base"
        [/label]
        [label]
            x,y=40,11
            text= _ "Eastern Base"
        [/label]

        # spawn defenders

        # team east
        [unit]
            side=7
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=41,15
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=7
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=41,8
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=7
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=39,6
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=7
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=39,17
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        # team West
        [unit]
            side=6
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=7,15
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=6
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=7,8
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=6
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=9,6
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=6
            type=Jinn
            # do not allow units to move
            max_moves=0
            moves=0
            x,y=9,17
            random_traits=no
            [modifications]
                {TRAIT_RESILIENT}
                [object]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
    [/event]

    # brazier sound source event
    [event]
        name=prestart
        [store_locations]
            terrain=*^Ebn
            variable=braziers
        [/store_locations]
        [for]
            array=braziers
            [do]
                [sound_source]
                    id=braziers[$i]
                    x,y=$braziers[$i].x,$braziers[$i].y
                    sounds=ambient/campfire.ogg
                    delay=0
                    chance=100
                    full_range=2
                    fade_range=6
                [/sound_source]
            [/do]
        [/for]

        {CLEAR_VARIABLE braziers}
    [/event]

    # start event
    [event]
        name=start

        # set up score board
        {SCORE_BOARD_HEADER}

        # update players on what they picked
        {IF_VAR knyght_CTF_monster_spawn_var equals yes (
            [then]
                {CHAT_MSG_UPDATE ( _ "AI Monster spawns (side 5) has been enabled.")}
            [/then]
            [else]
                {CHAT_MSG_UPDATE ( _ "AI Monster spawns (side 5) has been disabled.")}
            [/else]
        )}

        # update players on score threshold
        {CHAT_MSG_UPDATE ( _ "Maximum score limit has been set to $knyght_CTF_point_threshold")}

        # encouraging message
        {CHAT_MSG_UPDATE ( _ "Good luck and have fun!")}

        # more checks
        {IF_VAR knyght_CTF_team_east_defence equals no (
            [then]
                [kill]
                    side=7
                    animate=no
                [/kill]
            [/then]
        )}
        {IF_VAR knyght_CTF_team_west_defence equals no (
            [then]
                [kill]
                    side=6
                    animate=no
                [/kill]
            [/then]
        )}
    [/event]

    # options
    [options]
        # CTF point threshold slider 
        [slider]
            id=knyght_CTF_point_threshold
            # same as Xonotic CTF score threshold
            default=3
            min=2
            # what kind of maniac would play 10 score points?
            max=9
            step=1
            name= _ "Maximum Score Limit"
            description= _ "Select the score threshold for the scenario."
        [/slider]

        # compensate AI sides option
        [choice]
            id=knyght_CTF_compensate_AI
            default=yes
            name= _ "Compensate AI-Controlled players"
            description= _ "If enabled, AI-controlled sides are buffed slightly. Does not work on droided sides."

            [item]
                name= _ "Compensate AI Sides"
                value=yes
            [/item]
            [item]
                name= _ "Do no Compensate AI Sides"
                value=no
            [/item]
        [/choice]

        # AI side monster checkboxes
        [checkbox]
            id=knyght_CTF_monster_spawn_var
            default=no
            name= _ "AI Side Monster Spawns"
            description= _ "Choose whether to have AI monster spawns."
        [/checkbox]
        
        [choice]
            id=knyght_CTF_monster_spawn_strength
            default="normal"
            name= _ "Monster Spawn Strength"
            description= _ "Vary the strength of the spawned monster units."

            [item]
                name= _ "Easy"
                value="easy"
            [/item]
            [item]
                name= _ "Normal"
                value="normal"
            [/item]
            [item]
                name= _ "Hard"
                value="hard"
            [/item]
        [/choice]

        [checkbox]
            id=knyght_CTF_monster_spawn_spot1
            default=yes
            name= _ "Monster Spawn Spot 1"
            description= _ "Should monsters spawn at spot 1? Nothing will happen if monster spawns are disabled."
        [/checkbox]
        [checkbox]
            id=knyght_CTF_monster_spawn_spot2
            default=yes
            name= _ "Monster Spawn Spot 2"
            description= _ "Should monsters spawn at spot 2? Should monsters spawn at spot 1? Nothing will happen if monster spawns are disabled."
        [/checkbox]
        [checkbox]
            id=knyght_CTF_monster_spawn_spot3
            default=yes
            name= _ "Monster Spawn Spot 3"
            description= _ "Should monsters spawn at spot 3? Should monsters spawn at spot 1? Nothing will happen if monster spawns are disabled."
        [/checkbox]
        [checkbox]
            id=knyght_CTF_monster_spawn_spot4
            default=yes
            name= _ "Monster Spawn Spot 4"
            description= _ "Should monsters spawn at spot 4? Should monsters spawn at spot 1? Nothing will happen if monster spawns are disabled."
        [/checkbox]
        [checkbox]
            id=knyght_CTF_monster_spawn_spot5
            default=yes
            name= _ "Monster Spawn Spot 5"
            description= _ "Should monsters spawn at spot 5? Should monsters spawn at spot 1? Nothing will happen if monster spawns are disabled."
        [/checkbox]

        # checkbox for base defences
        [checkbox]
            id=knyght_CTF_team_west_defence
            default=yes
            name= _ "Western Base Defenders"
            description= _ "If enabled, spawns base defenders for the Western Base."
        [/checkbox]

        [choice]
            id=knyght_CTF_west_defender_strength
            default="hero"
            name= _ "Western Base Defender Power"
            description= _ "Vary the strength of the spawned defender units."

            [item]
                name= _ "Novice"
                value="novice"
            [/item]
            [item]
                name= _ "Hero"
                value="hero"
            [/item]
            [item]
                name= _ "Champion"
                value="champion"
            [/item]
        [/choice]

        [checkbox]
            id=knyght_CTF_team_east_defence
            default=yes
            name= _ "Eastern Base Defenders"
            description= _ "If enabled, spawns base defenders for the Eastern Base."
        [/checkbox]

        [choice]
            id=knyght_CTF_east_defender_strength
            default="hero"
            name= _ "Eastern Base Defender Power"
            description= _ "Vary the strength of the spawned defender units."

            [item]
                name= _ "Novice"
                value="novice"
            [/item]
            [item]
                name= _ "Hero"
                value="hero"
            [/item]
            [item]
                name= _ "Champion"
                value="champion"
            [/item]
        [/choice] 
    [/options]

    # set up AI mobs
    [event]
        name="side_5_turn"
        first_time_only=no

        # once every third turn
        [filter_condition]
            [lua]
                code=<< return wesnoth.current.turn % 4 == 0 >>
            [/lua]
            [and]
                {VARIABLE_CONDITIONAL knyght_CTF_monster_spawn_var equals yes}
            [/and]
        [/filter_condition]

        # we define 3 sets for variety
        {RANDOM "SetA,SetB,SetC"}

        [switch]
            variable=random

            [case]
                value=SetA

                # bats / falcons 
                {IF_VAR knyght_CTF_monster_spawn_spot1 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Blood Bat" 15 3}
                        {GENERIC_UNIT 5 "Blood Bat" 33 20}
                    [/then]
                )}

                # rats / ants / mudcrawlers
                {IF_VAR knyght_CTF_monster_spawn_spot2 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Giant Ant" 27 18}
                        {GENERIC_UNIT 5 "Giant Ant" 21 5}
                    [/then]
                )}

                # wolf / piglet / boar
                {IF_VAR knyght_CTF_monster_spawn_spot3 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Wolf" 25 2}
                        {GENERIC_UNIT 5 "Wolf" 23 21}
                    [/then]
                )}

                # scorpions
                {IF_VAR knyght_CTF_monster_spawn_spot4 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Giant Scorpion" 17 13}
                        {GENERIC_UNIT 5 "Giant Scorpion" 31 10}
                    [/then]
                )}

                # fire guardians
                {IF_VAR knyght_CTF_monster_spawn_spot5 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Fire Guardian" 15 20}
                        {GENERIC_UNIT 5 "Fire Guardian" 33  3}
                    [/then]
                )}

                # this set stays fixed
                {GENERIC_UNIT 5 "Caribe" 24 10}
                {GENERIC_UNIT 5 "Caribe" 24 12}
            [/case]

            [case]
                value=SetB

                # bats / falcons 
                {IF_VAR knyght_CTF_monster_spawn_spot1 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Vampire Bat" 15 3}
                        {GENERIC_UNIT 5 "Vampire Bat" 33 20}
                    [/then]
                )}

                # rats / ants / mudcrawlers
                {IF_VAR knyght_CTF_monster_spawn_spot2 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Fire Ant" 27 18}
                        {GENERIC_UNIT 5 "Fire Ant" 21 5}
                    [/then]
                )}

                # wolf / piglet / boar
                {IF_VAR knyght_CTF_monster_spawn_spot3 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Giant Mudcrawler" 25 2}
                        {GENERIC_UNIT 5 "Giant Mudcrawler" 23 21}
                    [/then]
                )}

                # scorpions
                {IF_VAR knyght_CTF_monster_spawn_spot4 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Rock Scorpion" 17 13}
                        {GENERIC_UNIT 5 "Rock Scorpion" 31 10}
                    [/then]
                )}

                # fire guardians
                {IF_VAR knyght_CTF_monster_spawn_spot5 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Fire Guardian" 15 20}
                        {GENERIC_UNIT 5 "Fire Guardian" 33  3}
                    [/then]
                )}

                # this set stays fixed
                {GENERIC_UNIT 5 "Nibbler" 24 10}
                {GENERIC_UNIT 5 "Nibbler" 24 12}
            [/case]

            [case]
                value=SetC

                # bats / falcons 
                {IF_VAR knyght_CTF_monster_spawn_spot1 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Vampire Bat" 15 3}
                        {GENERIC_UNIT 5 "Vampire Bat" 33 20}
                    [/then]
                )}

                # rats / ants / mudcrawlers
                {IF_VAR knyght_CTF_monster_spawn_spot2 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Giant Rat" 27 18}
                        {GENERIC_UNIT 5 "Giant Rat" 21 5}
                    [/then]
                )}

                # wolf / piglet / boar
                {IF_VAR knyght_CTF_monster_spawn_spot3 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Mudcrawler" 25 2}
                        {GENERIC_UNIT 5 "Mudcrawler" 23 21}
                    [/then]
                )}

                # scorpions
                {IF_VAR knyght_CTF_monster_spawn_spot4 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Giant Scorpion" 17 13}{VARIATION scuttler}
                        {GENERIC_UNIT 5 "Giant Scorpion" 31 10}{VARIATION scuttler}
                    [/then]
                )}

                # fire guardians
                {IF_VAR knyght_CTF_monster_spawn_spot5 equals yes (
                    [then]
                        {GENERIC_UNIT 5 "Fire Guardian" 15 20}
                        {GENERIC_UNIT 5 "Fire Guardian" 33  3}
                    [/then]
                )}

                # this set stays fixed
                {GENERIC_UNIT 5 "Nibbler" 24 10}
                {GENERIC_UNIT 5 "Nibbler" 24 12}
            [/case]
        [/switch]

        {CLEAR_VARIABLE random}
    [/event]

    # event to compensate AI for this scenario
    [event]
        name="side_turn_1"
        first_time_only=no
        id=ai_handicap_reverse

        [filter_condition]
            {VARIABLE_CONDITIONAL knyght_CTF_compensate_AI equals yes}
        [/filter_condition]

        [lua]
            code = <<
            local result = wesnoth.synchronize_choice(
                function()
                    return { value = "no" }
                end,
                function()
                    -- Called only on the client handling the current side, if it is an AI.
                    return { value = "yes" }
                end)
            wesnoth.set_variable("knyght_CTF_check_if_ai"..wesnoth.current.side,result.value)
            >>
        [/lua]

        [if]
            {VARIABLE_CONDITIONAL knyght_CTF_check_if_ai$side_number equals yes}
            [then]

                # exempt monster side
                [if]
                    {VARIABLE_CONDITIONAL side_number numerical_not_equals 5}
                    [then]

                        [gold]
                            side=$side_number
                            amount=25
                        [/gold]

                        [modify_side]
                            side=$side_number
                            income=6
                        [/modify_side]
                    [/then]
                [/if]
            [/then]
        [/if]
        {CLEAR_VARIABLE knyght_CTF_check_if_ai$side_number}
    [/event]

    # prevent leader death
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=1
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=1
            canrecruit=yes
        ) 4 8}

        {FULL_HEAL (
            side=1
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=3
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=3
            canrecruit=yes
        ) 3 14}

        {FULL_HEAL (
            side=3
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=4
            canrecruit=yes
        ) 45 9}

        {FULL_HEAL (
            side=4
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=2
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=2
            canrecruit=yes
        ) 44 14}

        {FULL_HEAL (
            side=2
            canrecruit=yes
        )}
    [/event]

    # Capture the Flag specific events

    # when side 1 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x,y=40,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=40,11
            terrain=Rb
        [/terrain]

        # setup the capture
        [capture_flag]
            x,y=40,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_east_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=1
            ai_type=protect_unit
            action=add
            ca_id=side1_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=8,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_WEST_STEAL_FLAG 1}
        {TEAM_WEST_STEAL_FLAG 3}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has taken the Eastern flag!")}
    [/event]
    # when side 1 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x,y=8,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=1
            ai_type=protect_unit
            ca_id=side1_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=8,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_west_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=40,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 1}
        {TEAM_WEST_AGGRESSION 3}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has scored a point!")}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 1 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=1
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=1
            ai_type=protect_unit
            ca_id=side1_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=40,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 1}
        {TEAM_WEST_AGGRESSION 3}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has retaken their flag!")}
    [/event]

    # when side 3 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            x,y=40,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=40,11
            terrain=Rb
        [/terrain]

        # setup the capture
        [capture_flag]
            x,y=40,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_east_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=3
            ai_type=protect_unit
            action=add
            ca_id=side3_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=8,11
            [/unit]
        [/micro_ai]

        # adjust AI
        {TEAM_WEST_STEAL_FLAG 3}
        {TEAM_WEST_STEAL_FLAG 1}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has taken the Eastern flag!")}
    [/event]
    # when side 3 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            x,y=8,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=3
            ai_type=protect_unit
            ca_id=side3_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=8,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_west_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=40,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 3}
        {TEAM_WEST_AGGRESSION 1}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has scored a point!")}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 3 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=3
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=3
            ai_type=protect_unit
            ca_id=side3_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=40,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 3}
        {TEAM_WEST_AGGRESSION 1}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has retaken their flag!")}
    [/event]

    # when side 2 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=2
            x,y=8,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=8,11
            terrain=Rb
        [/terrain]

        # setup the capture
        [capture_flag]
            x,y=8,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_west_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=2
            ai_type=protect_unit
            action=add
            ca_id=side2_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=40,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_EAST_STEAL_FLAG 2}
        {TEAM_EAST_STEAL_FLAG 4}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has taken the Western flag!")}
    [/event]
    # when side 2 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=2
            x,y=40,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=2
            ai_type=protect_unit
            ca_id=side2_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=40,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_east_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=8,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 2}
        {TEAM_EAST_AGGRESSION 4}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has scored a point!")}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 2 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=2
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=2
            ai_type=protect_unit
            ca_id=side2_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=8,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 2}
        {TEAM_EAST_AGGRESSION 4}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has retaken their flag!")}
    [/event]

    # when side 4 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=4
            x,y=8,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=8,11
            terrain=Rb
        [/terrain]

        # setup the capture
        [capture_flag]
            x,y=8,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_west_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=4
            ai_type=protect_unit
            action=add
            ca_id=side4_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=40,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_EAST_STEAL_FLAG 4}
        {TEAM_EAST_STEAL_FLAG 2}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has taken the Western flag!")}
    [/event]
    # when side 4 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=4
            x,y=40,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=4
            ai_type=protect_unit
            ca_id=side4_return_to_own_base
            action=delete
        [/micro_ai]
        {REMOVE_FLAG_OVERLAY}

        # release the flag
        [release_flag]
            x,y=40,11
            id=$unit.id
        [/release_flag]

        {VARIABLE_OP team_east_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=8,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 4}
        {TEAM_EAST_AGGRESSION 2}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team East has scored a point!")}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 4 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=4
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=4
            ai_type=protect_unit
            ca_id=side4_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=8,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 4}
        {TEAM_EAST_AGGRESSION 2}

        # update score
        {SCORE_BOARD_HEADER}

        # notify observers/players in chat
        {CHAT_MSG_UPDATE ( _ "Team West has retaken their flag!")}
    [/event]

    # score checking
    [event]
        name=score_checker_event
        id=knyght_ctf_score_check
        first_time_only=yes

        # check the condition
        # fire only when true
        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_score equals $knyght_CTF_point_threshold}
            [or]
                {VARIABLE_CONDITIONAL team_east_score equals $knyght_CTF_point_threshold}
            [/or]
        [/filter_condition]

        [if]
            {VARIABLE_CONDITIONAL team_west_score greater_than $team_east_score}

            [then]
                {CHAT_MSG_UPDATE ( _ "Team West wins!")}
                [endlevel]
                    [result]
                        side=1,3
                        result=victory
                    [/result]
                    [result]
                        side=2,4
                        result=defeat
                    [/result]
                [/endlevel]
            [/then]

            [else]
                {CHAT_MSG_UPDATE ( _ "Team East wins!")}
                [endlevel]
                    [result]
                        side=1,3
                        result=defeat
                    [/result]
                    [result]
                        side=2,4
                        result=victory
                    [/result]
                [/endlevel]
            [/else]
        [/if]
    [/event]
[/multiplayer]
#endif

#undef MP_CTF_SCENARIO_DESC
#undef CHAT_MSG_UPDATE
#undef SCORE_BOARD_HEADER
#undef SCORE_STR
#undef TEAM_EAST_AGGRESSION
#undef TEAM_EAST_STEAL_FLAG
#undef TEAM_WEST_AGGRESSION
#undef TEAM_WEST_STEAL_FLAG
#undef ADD_FLAG_OVERLAY
#undef REMOVE_FLAG_OVERLAY