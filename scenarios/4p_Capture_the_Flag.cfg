#textdomain wesnoth-Survivals_WoL

#define SCORE_STR
_ "West    | Captures Needed |    East 
    <span fgcolor='green'>$team_west_score</span>       |              <span fgcolor='khaki'>$knyght_CTF_point_threshold</span>             |       <span fgcolor='gold'>$team_east_score</span>
Team West Flag   |   Team East Flag
    <span fgcolor='green'>$team_west_flag_base</span>                |             <span fgcolor='gold'>$team_east_flag_base</span>"
#enddef

#define SCORE_BOARD_HEADER
    [header_message]
        caption= _ "Capture the Flag"
        message={SCORE_STR}
    [/header_message]
#enddef

#define TEAM_WEST_AGGRESSION SIDE
    # having scored AI must return to what it was doing before
    {MODIFY_AI_ADD_GOAL {SIDE} (
        # set off for enemy flag post
        [goal]
            id=side_{SIDE}_enemy_base
            name=target_location
            [criteria]
                x,y=36,11
            [/criteria]
            value=800
        [/goal]
    )}
#enddef

#define TEAM_WEST_STEAL_FLAG SIDE
    # AI side unit has stolen the flag
    # so we withdraw most units to middle
    {MODIFY_AI_DELETE_GOAL {SIDE} side_{SIDE}_enemy_base}
#enddef

#define TEAM_EAST_AGGRESSION SIDE
    # having scored AI must return to what it was doing before
    {MODIFY_AI_ADD_GOAL {SIDE} (
        # set off for enemy flag post
        [goal]
            id=side_{SIDE}_enemy_base
            name=target_location
            [criteria]
                x,y=4,11
            [/criteria]
            value=800
        [/goal]
    )}
#enddef

#define TEAM_EAST_STEAL_FLAG SIDE
    # AI side unit has stolen the flag
    # so we withdraw most units to middle
    {MODIFY_AI_DELETE_GOAL {SIDE} side_{SIDE}_enemy_base}
#enddef

#define ADD_FLAG_OVERLAY
    [unit_overlay]
        id=$unit.id
        image=overlays/flag-carrier.png
    [/unit_overlay]
#enddef

#define REMOVE_FLAG_OVERLAY
    [remove_unit_overlay]
        id=$unit.id
        image=overlays/flag-carrier.png
    [/remove_unit_overlay]
#enddef

[multiplayer]
    id=multiplayer_2v2_Capture_the_Flag_knyght
    name= _ "4p â€” Capture the Flag (2v2)"
    map_file=Capture_the_Flag.map
    turns=unlimited

    force_lock_settings=yes

    experience_modifier=70
    require_scenario=yes
    victory_when_enemies_defeated=no

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    # team west
    [side]
        side=1
        user_team_name=_ "West"
        team_name="west"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=3
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_1_enemy_base
                name=target_location
                [criteria]
                    x,y=36,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_1_home_base
                name=protect_location
                [criteria]
                    x,y=4,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_1_enemy_flag_carrier
                name=target
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_1_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
        [/ai]
    [/side]

    # team east
    [side]
        side=2
        user_team_name=_ "East"
        team_name="east"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=3
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_2_enemy_base
                name=target_location
                [criteria]
                    x,y=4,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_2_home_base
                name=protect_location
                [criteria]
                    x,y=36,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_2_enemy_flag_carrier
                name=target
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_2_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
        [/ai]
    [/side]

    # team west
    [side]
        side=3
        user_team_name=_ "West"
        team_name="west"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=3
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_3_enemy_base
                name=target_location
                [criteria]
                    x,y=36,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_3_home_base
                name=protect_location
                [criteria]
                    x,y=4,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_3_enemy_flag_carrier
                name=target
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_3_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
        [/ai]
    [/side]

    # team east
    [side]
        side=4
        user_team_name=_ "East"
        team_name="east"
        canrecruit=yes
        controller=human
        controller_lock=no
        gold=100
        gold_lock=yes
        fog=yes
        defeat_condition=never
        shroud=no
        income=2
        income_lock=yes
        team_lock=yes
        faction_lock=no
        leader_lock=no
        village_gold=1
        village_support=3
        [ai]
            {EXPERIMENTAL_AI}
            # set off for enemy flag post
            [goal]
                id=side_4_enemy_base
                name=target_location
                [criteria]
                    x,y=4,11
                [/criteria]
                value=800
            [/goal]
            # protect own flag
            [goal]
                id=side_4_home_base
                name=protect_location
                [criteria]
                    x,y=36,11
                [/criteria]
                value=600
                protect_radius=3
            [/goal]
            # focus enemy flag carrier
            [goal]
                id=side_4_enemy_flag_carrier
                name=target
                [criteria]
                    side=1,3
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
            # protect own flag carrier
            [goal]
                id=side_4_team_flag_carrier
                name=protect_unit
                [criteria]
                    side=2,4
                    [filter_wml]
                        [status]
                            flag_carrier=yes
                        [/status]
                    [/filter_wml]
                [/criteria]
                value=500
            [/goal]
        [/ai]
    [/side]

    # AI side
    [side]
        side=5
        user_team_name=_ "Monsters"
        team_name="monsters"
        controller=ai
        no_leader=yes
        gold=0
        income=-2
        defeat_condition=never
        hidden=yes
        fog=no
        shroud=no
        allow_player=no
        disallow_observers=yes
        controller_lock=yes
        team_lock=yes
        [ai]
            leader_value=7.0
            aggression=0.99
            caution=0.0
        [/ai]
    [/side]

    # load the lua
    [lua]
        code = <<
        wesnoth.dofile("~add-ons/Survivals_WoL/lua/header_message.lua")
    >>
    [/lua]
    [lua]
        code = <<
        wesnoth.dofile("~add-ons/Survivals_WoL/lua/capture_the_flag.lua")
    >>
    [/lua]

    # prestart event
    [event]
        name=prestart

        # adjust ambience
        {COLOR_ADJUST -15 -15 -15}

        # define team score vars 
        {VARIABLE team_west_score 0}
        {VARIABLE team_east_score 0}

        # more vars
        {VARIABLE team_west_flag_base "base"}
        {VARIABLE team_east_flag_base "base"}

        # objectives
        [objectives]
            [objective]
                description= _ "Capture the Opposing Team's Flag $knyght_CTF_point_threshold time(s)"
                condition="win"
            [/objective]
            [objective]
                description= _ "Your flag is capped $knyght_CTF_point_threshold time(s)"
                condition="lose"
            [/objective]

            [note]
                description= _ "Team Leaders cannot be killed permanently in this mode"
            [/note]
        [/objectives]
    [/event]

    # brazier sound source event
    [event]
        name=prestart
        [store_locations]
            terrain=*^Ebn
            variable=braziers
        [/store_locations]
        [for]
            array=braziers
            [do]
                [sound_source]
                    id=braziers[$i]
                    x,y=$braziers[$i].x,$braziers[$i].y
                    sounds=ambient/campfire.ogg
                    delay=0
                    chance=100
                    full_range=2
                    fade_range=6
                [/sound_source]
            [/do]
        [/for]

        {CLEAR_VARIABLE braziers}
    [/event]

    # start event
    [event]
        name=start

        # set up score board
        {SCORE_BOARD_HEADER}
    [/event]

    # options
    [options]
        [slider]
            id=knyght_CTF_point_threshold
            # same as Xonotic CTF score threshold
            default=3
            min=3
            # what kind of maniac would play 10 score points?
            max=10
            step=1
            name= _ "Maximum Score Limit"
            description= _ "Select the score threshold for the scenario."
        [/slider]
        [checkbox]
            id=knyght_CTF_monster_spawn_var
            default=yes
            name= _ "AI Side Monster Spawns"
            description= _ "Choose whether to have AI monster spawns."
        [/checkbox]
    [/options]

    # set up AI mobs
    [event]
        name="side_5_turn"
        first_time_only=no

        # once every third turn
        [filter_condition]
            [lua]
                code=<< return wesnoth.current.turn % 4 == 0 >>
            [/lua]
            [and]
                {VARIABLE_CONDITIONAL knyght_CTF_monster_spawn_var equals yes}
            [/and]
        [/filter_condition]

        # we define 3 sets for variety
        {RANDOM "SetA,SetB,SetC"}

        [switch]
            variable=random

            [case]
                value=SetA

                {GENERIC_UNIT 5 "Blood Bat" 11 3}
                {GENERIC_UNIT 5 "Blood Bat" 29 20}

                {GENERIC_UNIT 5 "Fire Guardian" 12 19}
                {GENERIC_UNIT 5 "Fire Guardian" 28  3}

                {GENERIC_UNIT 5 "Elder Falcon" 18 20}
                {GENERIC_UNIT 5 "Elder Falcon" 22  2}

                {GENERIC_UNIT 5 "Giant Scorpion" 13 13}
                {GENERIC_UNIT 5 "Giant Scorpion" 27 10}

                {GENERIC_UNIT 5 "Caribe" 20 10}
                {GENERIC_UNIT 5 "Caribe" 20 12}
            [/case]

            [case]
                value=SetB

                {GENERIC_UNIT 5 "Blood Bat" 11 3}
                {GENERIC_UNIT 5 "Blood Bat" 29 20}

                {GENERIC_UNIT 5 "Fire Guardian" 12 19}
                {GENERIC_UNIT 5 "Fire Guardian" 28  3}

                {GENERIC_UNIT 5 "Elder Falcon" 18 20}
                {GENERIC_UNIT 5 "Elder Falcon" 22  2}

                {GENERIC_UNIT 5 "Giant Scorpion" 13 13}
                {GENERIC_UNIT 5 "Giant Scorpion" 27 10}

                {GENERIC_UNIT 5 "Caribe" 20 10}
                {GENERIC_UNIT 5 "Caribe" 20 12}
            [/case]

            [case]
                value=SetC

                {GENERIC_UNIT 5 "Blood Bat" 11 3}
                {GENERIC_UNIT 5 "Blood Bat" 29 20}

                {GENERIC_UNIT 5 "Fire Guardian" 12 19}
                {GENERIC_UNIT 5 "Fire Guardian" 28  3}

                {GENERIC_UNIT 5 "Elder Falcon" 18 20}
                {GENERIC_UNIT 5 "Elder Falcon" 22  2}

                {GENERIC_UNIT 5 "Giant Scorpion" 13 13}
                {GENERIC_UNIT 5 "Giant Scorpion" 27 10}

                {GENERIC_UNIT 5 "Caribe" 20 10}
                {GENERIC_UNIT 5 "Caribe" 20 12}
            [/case]
        [/switch]

        {CLEAR_VARIABLE random}
    [/event]

    # event to compensate AI for this scenario
    [event]
        name="side_turn_1"
        first_time_only=no
        id=ai_handicap_reverse

        [lua]
            code = <<
            local result = wesnoth.synchronize_choice(
                function()
                    return { value = "no" }
                end,
                function()
                    -- Called only on the client handling the current side, if it is an AI.
                    return { value = "yes" }
                end)
            wesnoth.set_variable("knyght_domination_check_if_ai"..wesnoth.current.side,result.value)
            >>
        [/lua]

        [if]
            {VARIABLE_CONDITIONAL knyght_domination_check_if_ai$side_number equals yes}
            [then]

                # exempt monster side
                [if]
                    {VARIABLE_CONDITIONAL side_number numerical_not_equals 5}
                    [then]
                        [chat]
                            speaker="Update"
                            message=_"Side $side_number is an AI-controlled side and has been slightly compensated."
                        [/chat]

                        [gold]
                            side=$side_number
                            amount=25
                        [/gold]

                        [modify_side]
                            side=$side_number
                            income=6
                        [/modify_side]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    # prevent leader death
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=1
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=1
            canrecruit=yes
        ) 3 4}

        {FULL_HEAL (
            side=1
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=3
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=3
            canrecruit=yes
        ) 3 19}

        {FULL_HEAL (
            side=3
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=4
            canrecruit=yes
        ) 37 4}

        {FULL_HEAL (
            side=4
            canrecruit=yes
        )}
    [/event]
    [event]
        name="last breath"
        first_time_only=no
        [filter]
            side=2
            canrecruit=yes
        [/filter]

        {TELEPORT_UNIT (
            side=2
            canrecruit=yes
        ) 37 19}

        {FULL_HEAL (
            side=2
            canrecruit=yes
        )}
    [/event]

    # Capture the Flag specific events

    # when side 1 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x,y=36,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=36,11
            terrain=Rb
        [/terrain]

        # setup the return
        [capture_flag]
            x,y=36,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_east_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=1
            ai_type=protect_unit
            action=add
            ca_id=side1_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=4,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_WEST_STEAL_FLAG 1}
        {TEAM_WEST_STEAL_FLAG 3}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]
    # when side 1 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x,y=4,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=1
            ai_type=protect_unit
            ca_id=side1_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=4,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_west_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=36,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 1}
        {TEAM_WEST_AGGRESSION 3}

        # update score
        {SCORE_BOARD_HEADER}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 1 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=1
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=1
            ai_type=protect_unit
            ca_id=side1_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=36,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 1}
        {TEAM_WEST_AGGRESSION 3}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]

    # when side 3 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            x,y=36,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=36,11
            terrain=Rb
        [/terrain]

        # setup the return
        [capture_flag]
            x,y=36,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_east_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=3
            ai_type=protect_unit
            action=add
            ca_id=side3_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=4,11
            [/unit]
        [/micro_ai]

        # adjust AI
        {TEAM_WEST_STEAL_FLAG 3}
        {TEAM_WEST_STEAL_FLAG 1}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]
    # when side 3 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            x,y=4,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=3
            ai_type=protect_unit
            ca_id=side3_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=4,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_west_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=36,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 3}
        {TEAM_WEST_AGGRESSION 1}

        # update score
        {SCORE_BOARD_HEADER}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 3 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=3
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=3
            ai_type=protect_unit
            ca_id=side3_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_east_flag_base "base"}

        [terrain]
            x,y=36,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_WEST_AGGRESSION 3}
        {TEAM_WEST_AGGRESSION 1}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]

    # when side 2 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=2
            x,y=4,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=4,11
            terrain=Rb
        [/terrain]

        # setup the return
        [capture_flag]
            x,y=4,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_west_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=2
            ai_type=protect_unit
            action=add
            ca_id=side2_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=36,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_EAST_STEAL_FLAG 2}
        {TEAM_EAST_STEAL_FLAG 4}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]
    # when side 2 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=2
            x,y=36,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=2
            ai_type=protect_unit
            ca_id=side2_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            x,y=36,11
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        {VARIABLE_OP team_east_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=4,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 2}
        {TEAM_EAST_AGGRESSION 4}

        # update score
        {SCORE_BOARD_HEADER}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 2 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=2
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=2
            ai_type=protect_unit
            ca_id=side2_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=4,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 2}
        {TEAM_EAST_AGGRESSION 4}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]

    # when side 4 AI captures the enemy flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=4
            x,y=4,11
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_flag_base equals "base"}
        [/filter_condition]

        [terrain]
            x,y=4,11
            terrain=Rb
        [/terrain]

        # setup the return
        [capture_flag]
            x,y=4,11
            id=$unit.id
        [/capture_flag]
        {ADD_FLAG_OVERLAY}

        # take the flag status
        {VARIABLE team_west_flag_base "taken"}

        # setup micro AI
        [micro_ai]
            side=4
            ai_type=protect_unit
            action=add
            ca_id=side4_return_to_own_base
            #ca_score=300000

            [unit]
                id=$unit.id
                goal_x,goal_y=36,11
            [/unit]

        [/micro_ai]

        # adjust AI
        {TEAM_EAST_STEAL_FLAG 4}
        {TEAM_EAST_STEAL_FLAG 2}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]
    # when side 4 scores with flag
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=4
            x,y=36,11
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL team_east_flag_base equals "base"}
        [/filter_condition]

        # clean up MAI
        [micro_ai]
            side=4
            ai_type=protect_unit
            ca_id=side4_return_to_own_base
            action=delete
        [/micro_ai]
        {REMOVE_FLAG_OVERLAY}

        # release the flag
        [release_flag]
            x,y=36,11
            id=$unit.id
        [/release_flag]

        {VARIABLE_OP team_east_score add 1}
        [floating_text]
            x,y=$x1,$y1
            text= _ "Scored!"
        [/floating_text]

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=4,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 4}
        {TEAM_EAST_AGGRESSION 2}

        # update score
        {SCORE_BOARD_HEADER}

        # fire the score checker
        [fire_event]
            name=score_checker_event
        [/fire_event]
    [/event]
    # death of side 4 flag carrier
    [event]
        name="die"
        first_time_only=no

        [filter]
            side=4
            [filter_wml]
                [status]
                    flag_carrier=yes
                [/status]
            [/filter_wml]
        [/filter]

        # clean up MAI
        [micro_ai]
            side=4
            ai_type=protect_unit
            ca_id=side4_return_to_own_base
            action=delete
        [/micro_ai]

        # release the flag
        [release_flag]
            id=$unit.id
        [/release_flag]
        {REMOVE_FLAG_OVERLAY}

        # return enemy flag to their base
        {VARIABLE team_west_flag_base "base"}

        [terrain]
            x,y=4,11
            terrain="Cte"
        [/terrain]

        # adjust AI
        {TEAM_EAST_AGGRESSION 4}
        {TEAM_EAST_AGGRESSION 2}

        # update score
        {SCORE_BOARD_HEADER}
    [/event]

    # score checking
    [event]
        name=score_checker_event
        id=knyght_ctf_score_check
        first_time_only=yes

        # check the condition
        # fire only when true
        [filter_condition]
            {VARIABLE_CONDITIONAL team_west_score equals $knyght_CTF_point_threshold}
            [or]
                {VARIABLE_CONDITIONAL team_east_score equals $knyght_CTF_point_threshold}
            [/or]
        [/filter_condition]

        [if]
            {VARIABLE_CONDITIONAL team_west_score greater_than $team_east_score}

            [then]
                [header_message]
                    caption= _ "Team West is Victorious!"
                [/header_message]
                [endlevel]
                    [result]
                        side=1,3
                        result=victory
                    [/result]
                    [result]
                        side=2,4
                        result=defeat
                    [/result]
                [/endlevel]
            [/then]

            [else]
                [header_message]
                    caption= _ "Team East is Victorious!"
                [/header_message]
                [endlevel]
                    [result]
                        side=1,3
                        result=defeat
                    [/result]
                    [result]
                        side=2,4
                        result=victory
                    [/result]
                [/endlevel]
            [/else]
        [/if]
    [/event]
[/multiplayer]

#undef SCORE_BOARD_HEADER
#undef SCORE_STR
#undef TEAM_EAST_AGGRESSION
#undef TEAM_EAST_STEAL_FLAG
#undef TEAM_WEST_AGGRESSION
#undef TEAM_WEST_AGGRESSION
#undef ADD_FLAG_OVERLAY
#undef REMOVE_FLAG_OVERLAY